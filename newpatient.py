
#  AgeWell Project - Elderly Health Companion
from fpdf import FPDF
from datetime import datetime
import os
import joblib
import mysql.connector
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.mime.base import MIMEBase
from email import encoders
import pyttsx3


#  PDF REPORT GENERATOR

def generate_health_report(pid, age, hr, bp, chol, bmi, score, risk, food, exercise, logo_path=None):
    pdf = FPDF(format="A4")
    pdf.set_auto_page_break(auto=True, margin=15)
    pdf.add_page()

    # Styling 
    header_bg = (0, 120, 200)
    header_text = (255, 255, 255)
    title_color = (0, 90, 160)
    text_color = (0, 0, 0)

    # Header
    pdf.set_fill_color(*header_bg)
    pdf.rect(0, 0, 210, 20, "F")
    pdf.set_xy(10, 6)
    pdf.set_text_color(*header_text)
    pdf.set_font("Arial", "B", 14)
    pdf.cell(0, 8, "AgeWell - Elderly Health Report", ln=True)

    if logo_path and os.path.exists(logo_path):
        try:
            pdf.image(logo_path, x=160, y=4, w=30)
        except Exception:
            pass

    pdf.ln(8)
    pdf.set_text_color(*text_color)
    pdf.set_font("Arial", "", 10)
    pdf.cell(0, 6, f"Generated: {datetime.now():%Y-%m-%d %H:%M:%S}", ln=True)
    pdf.set_font("Arial", "B", 11)
    pdf.set_text_color(*title_color)
    pdf.cell(0, 7, f"Patient ID: {pid}   |   Predicted Risk: {risk}", ln=True)
    pdf.ln(3)

    # Stats 
    pdf.set_text_color(*text_color)
    pdf.set_font("Arial", "", 11)
    col_w, line_h = 95, 6
    pdf.set_x(10)
    pdf.cell(col_w, line_h, f"Age: {age}", border=0)
    pdf.cell(col_w, line_h, f"Heart Rate: {hr}", ln=True)
    pdf.set_x(10)
    pdf.cell(col_w, line_h, f"Systolic BP: {bp}", border=0)
    pdf.cell(col_w, line_h, f"Cholesterol: {chol}", ln=True)
    pdf.set_x(10)
    pdf.cell(col_w, line_h, f"BMI: {bmi}", border=0)
    pdf.cell(col_w, line_h, f"Health Score: {score}", ln=True)
    pdf.ln(6)
    pdf.set_draw_color(200, 200, 200)
    pdf.line(10, pdf.get_y(), 200, pdf.get_y())
    pdf.ln(4)

    # Food Plan 
    pdf.set_font("Arial", "B", 12)
    pdf.set_text_color(*title_color)
    pdf.cell(0, 7, "Personalized Food Plan", ln=True)
    pdf.set_font("Arial", "", 11)
    pdf.set_text_color(*text_color)
    pdf.multi_cell(0, 6, food)
    pdf.ln(4)

    # Exercise Plan 
    pdf.set_font("Arial", "B", 12)
    pdf.set_text_color(*title_color)
    pdf.cell(0, 7, "Personalized Exercise Plan", ln=True)
    pdf.set_font("Arial", "", 11)
    pdf.set_text_color(*text_color)
    pdf.multi_cell(0, 6, exercise)
    pdf.ln(6)

    # Footer
    pdf.set_text_color(120, 120, 120)
    pdf.set_font("Arial", "I", 9)
    pdf.cell(0, 6, "Generated by AgeWell AI Health System.", ln=True)

    # Save PDF
    filename = f"AgeWell_Report_Patient_{pid}.pdf"
    pdf.output(filename)
    return filename


#  PREDICTION

model = joblib.load("agewell_model.joblib")

print("\nEnter new patient details:\n")
age = int(input("Age: "))
hr = int(input("Heart Rate: "))
bp = int(input("Systolic BP: "))
chol = int(input("Cholesterol: "))
weight = float(input("Weight (kg): "))
height = float(input("Height (m): "))

prediction = model.predict([[age, hr, bp, chol]])[0]
risk_label = "High" if prediction == 1 else "Low"

bmi = round(weight / (height ** 2), 2)

health_score = 100
if bp > 140 or chol > 220:
    health_score -= 30
if hr > 100:
    health_score -= 20
if age > 70:
    health_score -= 10
if prediction == 1:
    health_score -= 20
health_score = max(0, health_score)


#  RECOMMENDATIONS

def get_food_chart(risk, bmi):
    if risk == "High":
        return "Low-fat diet: oats, fruits, grilled veggies, no fried food." if bmi > 25 \
            else "High-protein light diet: dal, fruits, boiled veggies."
    else:
        return "Balanced diet: milk, nuts, rice, dal, and vegetables."


def get_exercise_plan(risk, age, bmi):
    if risk == "High":
        return "Morning walk (30 min), yoga, and breathing exercises daily."
    elif bmi > 25:
        return "Brisk walk (40 min), cycling, avoid sitting long hours."
    else:
        return "Light jog, stretching, meditation, 20 min walk daily."


food_plan = get_food_chart(risk_label, bmi)
exercise_plan = get_exercise_plan(risk_label, age, bmi)

print(f"\n‚úÖ Predicted Risk: {risk_label}")
print(f"üìä BMI: {bmi} | üßÆ Health Score: {health_score}")
print(f"ü•ó Food Plan: {food_plan}")
print(f"üí™ Exercise Plan: {exercise_plan}")

engine = pyttsx3.init()
engine.say(f"The predicted risk is {risk_label}. BMI is {bmi} and health score is {health_score}.")
engine.runAndWait()


#  MYSQL INSERTION

try:
    conn = mysql.connector.connect(
        host="localhost",
        user="root",
        password="210605",
        database="agewell_db"
    )
    print("üß† Connected to:", conn.database)
    cur = conn.cursor()

    query = """INSERT INTO health_records
               (age, heart_rate, systolic_bp, cholesterol, risk, bmi, health_score, food_chart, exercise_plan, email_sent)
               VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)"""
    cur.execute(query, (age, hr, bp, chol, int(prediction), bmi, health_score, food_plan, exercise_plan, 0))
    conn.commit()

    cur.execute("SELECT MAX(patient_id) FROM health_records;")
    patient_id = cur.fetchone()[0]
    print(f"‚úÖ Data inserted successfully! Patient ID: {patient_id}")
    conn.close()

except Exception as e:
    print("‚ùå Database Error:", e)
    patient_id = None


#  EMAIL 

if prediction == 1 and patient_id:
    try:
        pdf_file = generate_health_report(patient_id, age, hr, bp, chol, bmi, health_score,
                                          risk_label, food_plan, exercise_plan)
        print(f"üìÑ PDF report generated: {pdf_file}")

        sender = "yashrajsharma786jmd@gmail.com"
        receiver = "vineetrajsharma12@gmail.com"
        password = "yiyw graa yjgd mrlc"   # Gmail App Password (no spaces)

        subject = f"AgeWell Health Alert - High Risk Patient (ID {patient_id})"
        body = f"""AGEWELL HEALTH ALERT

A high-risk patient has been detected by the AgeWell AI system.

Patient ID: {patient_id}
Age: {age}
Heart Rate: {hr}
BP: {bp}
Cholesterol: {chol}
BMI: {bmi}
Health Score: {health_score}

Recommended Plan:
{food_plan}
{exercise_plan}

Detailed report attached as PDF.

(This is an automated email generated by the AgeWell system.)
"""

        # Build Email
        message = MIMEMultipart()
        message["From"] = sender
        message["To"] = receiver
        message["Subject"] = subject
        message.attach(MIMEText(body, "plain", "utf-8"))

        # Attach PDF
        with open(pdf_file, "rb") as f:
            part = MIMEBase("application", "octet-stream")
            part.set_payload(f.read())
            encoders.encode_base64(part)
            part.add_header("Content-Disposition", f"attachment; filename={os.path.basename(pdf_file)}")
            message.attach(part)

        # Send Email
        with smtplib.SMTP_SSL("smtp.gmail.com", 465) as server:
            server.login(sender, password)
            server.send_message(message)

        print("üìß Email with PDF report sent successfully!")

        # Update database flag
        conn = mysql.connector.connect(
            host="localhost",
            user="root",
            password="210605",
            database="agewell_db"
        )
        cur = conn.cursor()
        cur.execute("UPDATE health_records SET email_sent=1 WHERE patient_id=%s", (patient_id,))
        conn.commit()
        conn.close()

    except Exception as e:
        print("‚ùå Email Error:", e)
